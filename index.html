<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tom the AI</title>
<style>
:root {
  --bg: #eef1f6;
  --card: #ffffff;
  --text: #111;
  --muted: #6c7a92;
  --accent: #4e7dff;
  --user: #dce7ff;
  --ai: #f2f4f7;
  --code: #0f4d0f;
}
[data-theme="dark"] {
  --bg: #0d1117;
  --card: #161b22;
  --text: #e6eef8;
  --muted: #9fb0c9;
  --accent: #4ea1ff;
  --user: #0b4a87;
  --ai: #111b27;
  --code: #1aff1a;
}

html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: Inter, system-ui, sans-serif; }
.container { max-width: 880px; margin: 20px auto; padding: 16px; }
header { display: flex; align-items: center; gap: 14px; margin-bottom: 12px; }
.logo { width: 56px; height: 56px; background: linear-gradient(135deg,#4e7dff,#8b5cff); border-radius: 14px; display:flex;align-items:center;justify-content:center;color:white;font-size:28px;font-weight:800;box-shadow:0 6px 18px rgba(0,0,0,0.15);}
h1 {margin:0;font-size:22px; display:inline;}
.controls {margin-left:auto;display:flex;align-items:center;gap:10px;}
label { color: var(--muted); font-size: 13px; }

/* Fixer button */
#fixerBtn {
  background: #ff5555;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 10px;
  font-size: 14px;
  cursor: pointer;
  margin-left: 12px;
  transition: 0.15s;
}
#fixerBtn:hover { background: #ff3333; }

#chat { background: var(--card); border-radius: 14px; height: 65vh; overflow-y: auto; padding: 16px; margin-top: 8px; box-shadow: 0 8px 22px rgba(0,0,0,0.09);}
.msg { display:flex;margin:10px 0; }
.bubble { max-width:75%; padding:13px 16px; border-radius:14px; line-height:1.4; box-shadow:0 3px 8px rgba(0,0,0,0.06);}
.user { margin-left:auto; background: var(--user); border-bottom-right-radius: 6px;}
.ai { margin-right:auto; background: var(--ai); border-bottom-left-radius: 6px;}
.inputRow { display:flex;gap:10px;margin-top:12px; flex-wrap:wrap;}
input[type="text"] { flex:1;padding:13px;border-radius:12px;border:1px solid #d0d7de;background:transparent;color:var(--text); font-size:15px;}
select { padding:12px; border-radius:12px; border:1px solid #d0d7de; background:var(--card); font-size:14px; cursor:pointer;}
button { padding:12px 15px; border-radius:12px; border:none; background:var(--accent); color:white; cursor:pointer; font-size:15px;}
button#clearBtn { background:#ff6666; }
button#clearAllBtn { background:#ff5555; }

.typing .dot { height:7px;width:7px;background: var(--muted);border-radius:50%;display:inline-block;margin-right:4px;opacity:0;animation:blink 1.2s infinite;}
.typing .dot:nth-child(2){ animation-delay: .15s }
.typing .dot:nth-child(3){ animation-delay: .3s }
@keyframes blink {0%{opacity:0}40%{opacity:1}80%{opacity:0}100%{opacity:0}}

.error { color: #ff6666; margin-top:8px;}
.codeBox { background:#0f0f0f; color:var(--code); padding:10px; border-radius:8px; font-family: monospace; white-space: pre-wrap; margin-top:6px; }
</style>
</head>
<body>
<div class="container">

<header>
  <div class="logo">T</div>
  <div>
    <h1>Tom the AI</h1>
    <button id="fixerBtn">Tom Fixer â€” Wen Only</button>
    <div class="muted">Chat with Tom anytime</div>
  </div>
  <div class="controls">
    <label>Dark</label>
    <input id="darkToggle" type="checkbox" />
  </div>
</header>

<!-- PERSONAS (Fixer removed) -->
<div style="margin-bottom:10px;">
  <label for="persona">Select Tom's type:</label>
  <select id="persona">
    <option value="human">Human Tom</option>
    <option value="coder">Tom the Coder</option>
    <option value="researcher">Tom the Researcher</option>
    <option value="image">Tom the Image AI (Coming Soon)</option>
  </select>
</div>

<div id="chat"></div>

<div class="inputRow">
  <input id="msg" type="text" placeholder="Ask Tom something..." />
  <button id="sendBtn">Send</button>
  <button id="clearBtn">Clear Chat</button>
  <button id="clearAllBtn">Clear All Chat History</button>
</div>

<div id="error" class="error"></div>
</div>

<script>
const APP_ID = "aZG4Su7oUextVdALeYgYE14Y7Yc5PrLEcUSzwXJp";
const REST_KEY = "6X6kPwMLSjaVADUiwPjXMinr5PdHPJ1exWVzlWbf";
const BACKEND_URL = "https://parseapi.back4app.com/functions/askAI";

const chatDiv = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const clearAllBtn = document.getElementById("clearAllBtn");
const errorDiv = document.getElementById("error");
const darkToggle = document.getElementById("darkToggle");
const personaSelect = document.getElementById("persona");

// ===== Fixer button =====
const fixerBtn = document.getElementById("fixerBtn");
fixerBtn.onclick = () => {
  const pass = prompt("Enter Fixer password:");
  if (pass === "Code") {
    window.location.href = "https://math12393.github.io/HTML-HELPER/";
  }
};

// ===== Dark mode =====
const savedTheme = localStorage.getItem("theme") || "light";
document.documentElement.setAttribute("data-theme", savedTheme);
darkToggle.checked = savedTheme==="dark";
darkToggle.onclick = () => {
  const theme = darkToggle.checked?"dark":"light";
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("theme", theme);
};

// ===== Chat history =====
const userKey = localStorage.getItem("userKey") || ("u_"+Math.random().toString(36).slice(2,9));
localStorage.setItem("userKey", userKey);

function loadLocalHistory(){
  const history = JSON.parse(localStorage.getItem("chat_history")||"[]");
  chatDiv.innerHTML="";
  history.forEach(m=>{
    if(m.persona===personaSelect.value) addMessageToUI(m.from,m.text,false,m.persona);
  });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function addMessageToUI(from,text,save=true,persona=personaSelect.value){
  const m = document.createElement("div");
  m.className="msg";
  const b = document.createElement("div");
  b.className="bubble "+(from==="user"?"user":"ai");

  if(persona==="coder" && from==="ai"){
    const codeBox = document.createElement("div");
    codeBox.className="codeBox";
    codeBox.textContent = text;
    b.appendChild(codeBox);
  } else if(persona==="human" && from==="ai"){
    b.innerHTML = `<strong>Human Tom:</strong> ${text}`;
  } else if(persona==="researcher" && from==="ai"){
    b.innerHTML = `<strong>Researcher Tom:</strong> ${text}`;
  } else if(persona==="image" && from==="ai"){
    b.innerHTML = `<strong>Image Tom:</strong> COMING SOON`;
  } else {
    b.innerHTML = text;
  }

  m.appendChild(b);
  chatDiv.appendChild(m);

  if(save){
    const h = JSON.parse(localStorage.getItem("chat_history")||"[]");
    h.push({from,text,time:Date.now(),persona});
    localStorage.setItem("chat_history",JSON.stringify(h));
  }

  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function showTyping(){
  const m = document.createElement("div");
  m.className="msg";
  m.id="typingRow";
  m.innerHTML=`<div class="bubble ai"><strong>Tom is typing</strong>
  <span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>`;
  chatDiv.appendChild(m);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}
function hideTyping(){
  const t = document.getElementById("typingRow");
  if(t) t.remove();
}

// ===== Sending messages =====
sendBtn.onclick=sendMessage;
msgInput.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){ sendMessage(); e.preventDefault(); }
  if(e.key==="Enter" && e.shiftKey){
    const start = msgInput.selectionStart;
    const end = msgInput.selectionEnd;
    msgInput.value = msgInput.value.substring(0,start)+"\n"+msgInput.value.substring(end);
    msgInput.selectionStart = msgInput.selectionEnd = start+1;
    e.preventDefault();
  }
});

async function sendMessage(){
  const text = msgInput.value.trim();
  if(!text) return;
  const persona = personaSelect.value;
  const promptPassword = (persona==="fixer") ? prompt("Enter Fixer password:") || "" : "";

  addMessageToUI("user",text);
  msgInput.value="";
  errorDiv.textContent="";
  showTyping();

  if(persona==="image"){
    setTimeout(()=>{ hideTyping(); addMessageToUI("ai","Image persona is coming soon!",true,persona); },800);
    return;
  }

  try{
    const res = await fetch(BACKEND_URL,{
      method:"POST",
      headers:{
        "X-Parse-Application-Id":APP_ID,
        "X-Parse-REST-API-Key":REST_KEY,
        "Content-Type":"application/json"
      },
      body: JSON.stringify({ prompt:text, userKey, persona, password: promptPassword })
    });

    if(!res.ok) throw new Error(`Server error: ${res.status}`);
    const data = await res.json();
    hideTyping();
    const reply = data.result?.choices?.[0]?.message?.content || "Tom didn't understand.";
    addMessageToUI("ai",reply,true,persona);

  }catch(err){
    hideTyping();
    errorDiv.textContent="Error: "+err.message;
  }
}

clearBtn.onclick=()=>{
  if(confirm("Are you sure you want to clear the chat?")){
    const history = JSON.parse(localStorage.getItem("chat_history")||"[]");
    const newHistory = history.filter(m=>m.persona!==personaSelect.value);
    localStorage.setItem("chat_history",JSON.stringify(newHistory));
    loadLocalHistory();
  }
};

clearAllBtn.onclick=()=>{
  if(confirm("Are you sure you want to clear ALL chat history?")){
    localStorage.removeItem("chat_history");
    chatDiv.innerHTML="";
  }
};

personaSelect.onchange = loadLocalHistory;
loadLocalHistory();
</script>
</body>
</html>
